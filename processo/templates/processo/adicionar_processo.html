{% extends "base.html" %}

{% block title %}Adicionar Processo{% endblock %}

{% block content %}

<h2>Adicionar Processo</h2>
<form method="post">
  {% csrf_token %}
  <label>T√≠tulo:</label>
  <input type="text" name="titulo" class="form-control" ><br>

  <label>Descri√ß√£o:</label>
  <textarea class="form-control" name="descricao"></textarea><br>

  <div class="mb-3" style="position: relative;">
      <label for="funcionario_busca">Buscar Funcion√°rio:</label>
      <input type="text" id="funcionario_busca" class="form-control" placeholder="Digite o nome do funcion√°rio..." autocomplete="off">
      <input type="hidden" name="funcionario" id="funcionario_id">

      <ul id="resultado_funcionarios" 
          class="list-group mt-2" 
          style="display: none; border: 1px solid #ccc; background: white; max-height: 200px; overflow-y: auto; position: absolute; z-index: 1000; width: 100%; top: 100%; left: 0;">
      </ul>
    </div>
    </div>
 <div class="text-center">
  <button type="submit" class="btn btn-primary w-50 py-2 mt-2">Salvar</button>
</div>
</form>


<script>
document.addEventListener('DOMContentLoaded', function() {
  const buscaInput = document.getElementById('funcionario_busca');
  const lista = document.getElementById('resultado_funcionarios');

  buscaInput.addEventListener('input', function() {
    const termo = this.value.trim();
    lista.innerHTML = ''; // limpa resultados anteriores

    if (termo.length < 2) return; // s√≥ busca a partir de 2 letras

    console.log("üîé Buscando:", termo);

    fetch(`/pessoa/buscar-funcionarios/?q=${encodeURIComponent(termo)}`)
      .then(response => response.json())
      .then(data => {
        console.log("üì¶ Retorno:", data);

        if (data.length === 0) {
          const vazio = document.createElement('li');
          vazio.classList.add('list-group-item', 'text-muted');
          vazio.textContent = 'Nenhum funcion√°rio encontrado';
          lista.appendChild(vazio);
          lista.style.display = 'block';
          return;
        }

        data.forEach(funcionario => {
          const item = document.createElement('li');
          item.classList.add('list-group-item', 'list-group-item-action');
          item.textContent = funcionario.username;

          item.addEventListener('click', () => {
            buscaInput.value = funcionario.username;
            document.getElementById('funcionario_id').value = funcionario.id;
            lista.innerHTML = '';
            lista.style.display = 'none';
          });

          lista.appendChild(item);
        });

        lista.style.display = 'block';
      })
      .catch(error => console.error('‚ùå Erro ao buscar funcion√°rios:', error));
  });

  // Fecha lista ao clicar fora
  document.addEventListener('click', (e) => {
    if (!e.target.closest('#resultado_funcionarios') && e.target !== buscaInput) {
      lista.innerHTML = '';
      lista.style.display = 'none';
    }
  });
});
</script>
{% endblock %}